<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/static/main.css" />
    <!-- <script src="/static/index.js" defer></script> -->
    <title>Document</title>
  </head>
  <body>
    <div class="container">
      <div class="spinner"></div>
      <div class="error" style="display: none"></div>
      <div class="table" style="display: none">
        <div class="button-inner">
          <button id="refresh" class="gradient-button">Refresh books</button>
          <button id="delete-books" class="delete-button" disabled>Delete book</button>
        </div>

        <div class="modal modal__hidden">
          <div class="modal__overlay"></div>
          <div class="modal__content"></div>
        </div>

        <fieldset>
          <legend>Add new book</legend>
          <form id="add-book-form">
            <div class="input-inner">
              <input required type="text" name="name" placeholder="Title" />
              <input required type="text" name="author" placeholder="Author" />
              <input required type="text" name="genre" placeholder="Genre" />
              <input required type="number" name="year" placeholder="Year" />
              <button class="submit-button">Create book</button>
            </div>
          </form>
        </fieldset>

        <table class="books">
          <thead>
            <tr>
              <th><input class="checkbox-all" type="checkbox" /></th>
              <th class="sortable">
                <button class="sortable-button" data-field="name">
                  Title of the book
                </button>
                <div class="sort-options hidden">
                  <button class="sort-remove">↕</button>
                  <button class="sort-toggle">↓</button>
                </div>
              </th>
              <th class="sortable">
                <button class="sortable-button" data-field="author">Author</button>
                <div class="sort-options hidden">
                  <button class="sort-remove">↕</button>
                  <button class="sort-toggle">↓</button>
                </div>
              </th>
              <th class="sortable">
                <button class="sortable-button" data-field="genre">Genre</button>
                <div class="sort-options hidden">
                  <button class="sort-remove">↕</button>
                  <button class="sort-toggle">↓</button>
                </div>
              </th>
              <th class="sortable">
                <button class="sortable-button" data-field="year">Release Year</button>
                <div class="sort-options hidden">
                  <button class="sort-remove">↕</button>
                  <button class="sort-toggle">↓</button>
                </div>
              </th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <!-- <table class="authors">
          <thead>
            <tr>
              <th><input class="checkbox-all" type="checkbox" /></th>
              <th>Name</th>
              <th>Nationality</th>
              <th>Date of birth</th>
              <th>Date of death</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table> -->
      </div>
    </div>
    <script>
      const refreshButton = document.querySelector('#refresh');
      const spinner = document.querySelector('.spinner');
      const sortables = document.querySelectorAll('.sortable');

      const table = document.querySelector('.table');
      const tbody = document.querySelector('.books tbody');
      const tbodyAuthors = document.querySelector('.authors tbody');

      const error = document.querySelector('.error');
      const addBookForm = document.querySelector('#add-book-form');
      const deleteBooksButton = document.querySelector('#delete-books');
      const checkboxSelectAll = document.querySelector('.books .checkbox-all');

      const modal = document.querySelector('.modal');
      const modalContent = document.querySelector('.modal__content');
      const modalOverlay = document.querySelector('.modal__overlay');

      modalOverlay.addEventListener('click', () => {
        modal.classList.add('modal__hidden');
      });

      // 0 - start of the line (NORMAL, first character)
      // ^ - start of the line (NORMAL, first non whitespace character).
      // $ - end of the line (NORMAL).
      // gm - middle of the line (NORMAL).
      // I - start of the line (INSERT).
      // A - end of  the line (INSERT).

      addBookForm.addEventListener('submit', async e => {
        e.preventDefault();
        const { name, author, genre, year } = addBookForm.elements;

        const response = await fetch('api/books', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            name: name.value,
            author: author.value,
            genre: genre.value,
            year: year.value,
          }),
        });
        const book = await response.json();
        if (response.status === 201) {
          const response2 = await fetch('api/books');
          const books = await response2.json();
          renderBooks(books);
          addBookForm.reset();
        }
      });

      // TODO: refactor duplicate code.
      // TODO: sort by columns.
      // TODO: pagination.
      // TODO: filters.

      const ORDERING = {
        ASC: '',
        DESC: '-',
      };

      let orderingDirection = ORDERING.ASC;
      let previousSortOptions = null;

      sortables.forEach(th => {
        const button = th.querySelector('.sortable-button');
        const sortOptions = th.querySelector('.sort-options');
        const removeButton = th.querySelector('.sort-remove');
        const toggleButton = th.querySelector('.sort-toggle');
        const orderingField = button.dataset.field;

        button.addEventListener('click', async () => {
          const response = await fetch(`api/books?ordering=${orderingField}`);
          const books = await response.json();
          renderBooks(books);

          if (previousSortOptions) {
            previousSortOptions.classList.add('hidden');
          }

          sortOptions.classList.remove('hidden');
          previousSortOptions = sortOptions;
        });

        toggleButton.addEventListener('click', async () => {
          orderingDirection =
            orderingDirection === ORDERING.ASC ? ORDERING.DESC : ORDERING.ASC;
          const response = await fetch(
            `api/books?ordering=${orderingDirection}${orderingField}`,
          );
          const books = await response.json();
          renderBooks(books);
          toggleButton.textContent = orderingDirection === ORDERING.ASC ? '↓' : '↑';
        });

        removeButton.addEventListener('click', async () => {
          orderingDirection = ORDERING.ASC;
          toggleButton.textContent = '↓';
          sortOptions.classList.add('hidden');
          const response = await fetch('api/books');
          const books = await response.json();
          renderBooks(books);
        });
      });
      // click
      // ↕ '↓'
      // ↕ '↑'

      refreshButton.addEventListener('click', async () => {
        refreshButton.setAttribute('disabled', 'true');
        refreshButton.textContent = 'Loading...';

        const response = await fetch('api/books');
        const data = await response.json();

        refreshButton.removeAttribute('disabled');
        refreshButton.textContent = 'Refresh books';

        if (response.status >= 400) {
          error.style.display = 'block';
          error.textContent = data.message;
        } else {
          renderBooks(data);
        }
      });

      async function fetchBooks() {
        const response = await fetch('api/books');
        const data = await response.json();

        spinner.style.display = 'none';
        if (/^[45]/.test(response.status)) {
          error.style.display = 'block';
          error.textContent = data.message;
        } else {
          table.style.display = 'table';
          error.style.display = 'none';
          renderBooks(data);
        }
      }

      function renderBooks(books) {
        tbody.innerHTML = '';

        for (const book of books) {
          tbody.innerHTML += /*html*/ `
                 <tr>
                   <td><input class="checkbox" type="checkbox" data-book-id="${book.id}"></td>
                   <td><button class="change-button" title='Change' aria-label="Change ${book.name}" data-book-id="${book.id}">${book.name}</button></td>
                   <td>${book.author}</td>
                   <td>${book.genre}</td>
                   <td>${book.year}</td>
                 </tr>
               `;
        }
        const changeButtons = document.querySelectorAll('.books .change-button');
        const checkboxBooks = document.querySelectorAll('.books .checkbox');

        changeButtons.forEach(button => {
          button.addEventListener('click', async () => {
            // 1. получить id
            const id = button.dataset.bookId;

            // 2. получить данные по id
            const response = await fetch(`api/books/${id}`);

            // 3. достать данные из запрос
            const book = await response.json();

            // 4. отрисовать данные в форму для изменения
            modal.classList.remove('modal__hidden');

            modalContent.innerHTML = /*html*/ `
              <form id="add-book-form">
                <div class="input-inner">
                  <input required type="text" name="name" placeholder="Title" value="${book.name}" />
                  <input required type="text" name="author" placeholder="Author" value="${book.author}" />
                  <input required type="text" name="genre" placeholder="Genre" value="${book.genre}"/>
                  <input required type="number" name="year" placeholder="Year" value="${book.year}"/>
                  <button id="save-book" class="submit-button">Save</button>
                </div>
              </form>
          `;
            // 5.отправить изменения на сервер
            const addBookForm = document.querySelector('#add-book-form');
            addBookForm.addEventListener('submit', async e => {
              e.preventDefault();
              const { name, author, genre, year } = addBookForm.elements;
              const response = await fetch(`api/books/${id}`, {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  name: name.value,
                  author: author.value,
                  genre: genre.value,
                  year: year.value,
                }),
              });

              modal.classList.add('modal__hidden');
              if (response.status === 200) {
                const response = await fetch('api/books');
                const books = await response.json();
                renderBooks(books);
              }
            });
          });
        });
        // show modal
        // with form filled with book details.
        // and buttons to cancel or update that book.

        checkboxBooks.forEach(el =>
          el.addEventListener('change', () => {
            // prettier-ignore
            deleteBooksButton.disabled = Array.from(checkboxBooks).every( el => !el.checked,);
          }),
        );
      }

      checkboxSelectAll.addEventListener('change', () => {
        const checkboxBooks = document.querySelectorAll('.books .checkbox');
        checkboxBooks.forEach(el => {
          el.checked = checkboxSelectAll.checked;
          el.dispatchEvent(new Event('change'));
        });
      });

      deleteBooksButton.addEventListener('click', () => {
        const checkboxBooks = document.querySelectorAll('.books .checkbox');

        modal.classList.remove('modal__hidden');
        modalContent.innerHTML = `
          <div class="modal__header">
            <p>Want delete?</p>
          </div>
          <div class="modal__footer">
            <button class="modal__button modal__cancel">Cancel</button>
            <button class="modal__button modal__confirm">Yes</button>
          </div>
        `;

        const modalConfirmButton = document.querySelector('.modal__confirm');
        const modalCancelButton = document.querySelector('.modal__cancel');

        function onCancelClick() {
          modal.classList.add('modal__hidden');
          modalContent.innerHTML = '';
          modalCancelButton.removeEventListener('click', onCancelClick);
          modalConfirmButton.removeEventListener('click', onConfirmClick);
        }

        async function onConfirmClick() {
          const ids = Array.from(checkboxBooks)
            .filter(el => el.checked)
            .map(el => el.dataset.bookId);
          // <p aria-label="" data-my-attribute="some value" data-my-value="dfd"></p>
          // el.dataset { myAttribute: 'some value', myValue: 'dfd' }
          // el.dataset.myAttribute

          const query = ids.map(id => `id=${id}`).join('&');
          const response = await fetch(`api/books/?${query}`, { method: 'DELETE' });
          deleteBooksButton.disabled = 'true';

          if (response.status === 204) {
            const response2 = await fetch('api/books');
            const books = await response2.json();
            renderBooks(books);
          }

          onCancelClick();
        }

        modalCancelButton.addEventListener('click', onCancelClick);
        modalConfirmButton.addEventListener('click', onConfirmClick);
      });

      fetchBooks();
    </script>
  </body>
</html>
